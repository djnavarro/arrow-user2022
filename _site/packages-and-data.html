<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.282">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Apache Arrow in R - Packages and Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Apache Arrow in R</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html">Home</a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorial" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tutorial</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorial">    
        <li>
    <a class="dropdown-item" href="./packages-and-data.html">
 <span class="dropdown-text">0: Packages and Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./hello-arrow.html">
 <span class="dropdown-text">1: Hello Arrow</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./data-wrangling.html">
 <span class="dropdown-text">2: Data Wrangling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./data-storage.html">
 <span class="dropdown-text">3: Data Storage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./advanced.html">
 <span class="dropdown-text">4: Advanced Arrow</span></a>
  </li>  
    </ul>
  </li>
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#packages" id="toc-packages" class="nav-link active" data-scroll-target="#packages">Packages</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a>
  <ul class="collapse">
  <li><a href="#the-tiny-nyc-taxi-data-set" id="toc-the-tiny-nyc-taxi-data-set" class="nav-link" data-scroll-target="#the-tiny-nyc-taxi-data-set">The tiny NYC taxi data set</a></li>
  <li><a href="#the-full-nyc-taxi-data-set" id="toc-the-full-nyc-taxi-data-set" class="nav-link" data-scroll-target="#the-full-nyc-taxi-data-set">The full NYC taxi data set</a></li>
  <li><a href="#ancillary-data-files" id="toc-ancillary-data-files" class="nav-link" data-scroll-target="#ancillary-data-files">Ancillary data files</a></li>
  </ul></li>
  <li><a href="#checks" id="toc-checks" class="nav-link" data-scroll-target="#checks">Checks</a>
  <ul class="collapse">
  <li><a href="#loading-the-data" id="toc-loading-the-data" class="nav-link" data-scroll-target="#loading-the-data">Loading the data</a></li>
  <li><a href="#a-dplyr-pipeline" id="toc-a-dplyr-pipeline" class="nav-link" data-scroll-target="#a-dplyr-pipeline">A dplyr pipeline</a></li>
  <li><a href="#extras" id="toc-extras" class="nav-link" data-scroll-target="#extras">Extras!</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Packages and Data</h1>
</div>





<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="packages" class="level2">
<h2 class="anchored" data-anchor-id="packages">Packages</h2>
<p>To install the required packages, run the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="fu">c</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"arrow"</span>, <span class="st">"dplyr"</span>, <span class="st">"dbplyr"</span>, <span class="st">"duckdb"</span>, <span class="st">"fs"</span>, <span class="st">"janitor"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"palmerpenguins"</span>, <span class="st">"remotes"</span>, <span class="st">"scales"</span>, <span class="st">"stringr"</span>, </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lubridate"</span>, <span class="st">"tictoc"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To load them:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dbplyr)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(duckdb)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(palmerpenguins)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The workshop doesn’t use graphics or spatial data much but they are used on this page and again at the end. Suggested packages if you want to run those parts of the code can be installed with the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">"ggplot2"</span>, <span class="st">"ggrepel"</span>, <span class="st">"sf"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Load the packages with this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>Throughout the workshop we’ll be relying on the New York City taxicab data set (instructions on obtaining the data are included below). In its full form, the data set takes the form of one very large table with about 1.7 billion rows and 24 columns. Each row corresponds to a single taxi ride sometime between 2009 and 2022. The contents of the columns are as follows:</p>
<ul>
<li><code>vendor_name</code> (string): A code indicating the service provider that maintains the taxicab technology system in that vehicle. Possible values here are “VTS”, “DDS” and “CMT”.</li>
<li><code>pickup_datetime</code> (timestamp): Specifies the time at which the customer was picked up. This is stored as an Arrow timestamp, which is analogous to a POSIXct object in R and can be manipulated in similar ways.</li>
<li><code>dropoff_datetime</code> (timestamp): Specifies the time at which the customer was dropped off.</li>
<li><code>passenger_count</code> (int64): An integer specifying the number of passengers. Note that this is not automatically computed: the value is manually entered by the driver.</li>
<li><code>trip_distance</code> (double): The elapsed trip distance reported by the taximeter. Note that this is a US based dataset so the distance is recorded in miles (not kilometers).</li>
<li><code>pickup_longitude</code> (double): Longitude data for the pickup location</li>
<li><code>pickup_latitude</code> (double): Latitude data for the pickup location</li>
<li><code>rate_code</code> (string): Different trips charge fees at different rates, often due to airport surcharges, and those rates are assigned codes. String specifying the final rate code in effect at the end of the trip. Possible values are: “Standard rate”, “JFK”, “Newark”, “Negotiated”, “Nassau or Westchester”, and “Group ride”</li>
<li><code>store_and_fwd</code> (string): Sometimes the vehicle does not have an internet connection and so the trip data is not immediately transmitted to the server. This is referred to as a “store and forward” case. The <code>store_and_fwd</code> flag is set to “Yes” when the vehicle did not immediately transmit, and “No” when it was able to transmit immediately.</li>
<li><code>dropoff_longitude</code> (double): Longitude data for the dropoff location</li>
<li><code>dropoff_latitude</code> (double): Latitude data for the dropoff location</li>
<li><code>payment_type</code> (string): Variable indicating how the customer paid for the ride. Values that occur in the data are “Cash”, “Credit card”, “No charge”, “Dispute” and “Unknown” (and of course missing data), but “Voided trip” is also possible according to the original documentation.</li>
<li><code>fare_amount</code> (double): The “time and distance” fare in US dollars calculated by the meter.</li>
<li><code>extra</code> (double): Additional extras and surcharges added to the fare amount. This includes US$0.50 and US$1 rush hour and overnight charges.</li>
<li><code>mta_tax</code> (double): The MTA is the “Metropolitan Transportation Authority” that governs public transport in New York City. This variable includes the US$0.50 MTA tax that is triggered based on the rate code in use.</li>
<li><code>tip_amount</code> (double): In the US it is customary for passengers to provide the taxi driver with an additional “tip” payment for service. This field records the tip amount paid only for credit card transactions: cash tips are not recorded.</li>
<li><code>tolls_amount</code> (double): As in many cities, various roads in NYC charge additional fees (“tolls”) to use them. Any tolls incurred are recorded here.</li>
<li><code>total_amount</code> (double): This is the total amount charged to the customer (excluding cash tips, which are not recorded in the data set).<br>
</li>
<li><code>improvement_surcharge</code> (double): The improvement surcharge is an additional US$0.30 fee that began in 2015. According to the official documentation it is “assessed on hailed trips at the flag drop”. I honestly have no idea what that means.<br>
</li>
<li><code>congestion_surcharge</code> (double): As in many cities, NYC imposes a congestion surcharge for vehicles that enter certain locations in the city. Any congestion fee incurred is recorded here.</li>
<li><code>pickup_location_id</code> (int64): The “TLC Taxi Zone” in which the pickup occurred. This is a numeric id ranging from 1 to 265: more information about the taxi zones is provided below.</li>
<li><code>dropoff_location_id</code> (int64): The “TLC Taxi Zone” in which the dropoff occurred.</li>
<li><code>year</code> (int32): The year in which the ride took place</li>
<li><code>month</code> (int32): The month in which the ride took place</li>
</ul>
<section id="the-tiny-nyc-taxi-data-set" class="level3">
<h3 class="anchored" data-anchor-id="the-tiny-nyc-taxi-data-set">The tiny NYC taxi data set</h3>
<p>In a moment we’ll talk about how to get the full data set, but let’s start with a simpler version!</p>
<p>In practice, not everyone has time or hard disk space to download the entire data set. On top of that, it’s not always a good idea to do your learning on an enormous data set: mistakes become more time consuming with big data. So it’s often helpful to practice with a smaller data set that has the exact same structure as the larger one that you want to use later. To help out with that, we’ve created the “Tiny NYC Taxi” data that contains only 1 in 1000 rows from the original data set. So instead of working with 1.7 billion rows of data and about 70GB of files, the tiny taxi data set is 1.7 million rows and about 80MB of files.</p>
<p>All you have to do is download the <a href="https://github.com/djnavarro/arrow-user2022/releases/download/v0.1/nyc-taxi-tiny.zip">nyc-taxi-tiny.zip</a> archive and unzip it, and you’re ready to start. On my machine I saved a copy of the data to a folder called <code>"~/Datasets/nyc-taxi-tiny"</code>. So if I wanted to use the tiny taxi data for this workshop, I could open the data set with this command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>nyc_taxi <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(<span class="st">"~/Datasets/nyc-taxi-tiny"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-full-nyc-taxi-data-set" class="level3">
<h3 class="anchored" data-anchor-id="the-full-nyc-taxi-data-set">The full NYC taxi data set</h3>
<p>Obtaining a copy of the full data set requires a little bit more effort. It’s stored online in an Amazon S3 bucket, and you can download all the files directly from there. In fact, the <strong>arrow</strong> package has commands to do that. On my machine I saved the full data set to a folder called <code>"~/Datasets/nyc-taxi"</code>, so the command I used looked like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">copy_files</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">from =</span> <span class="fu">s3_bucket</span>(<span class="st">"ursa-labs-taxi-data-v2"</span>),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">to =</span> <span class="st">"~/Datasets/nyc-taxi"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Be warned!</p>
<p>Conceptually this is easy, but in practice it may be painful. Depending on the quality of your internet connection this is likely to take a long time. The data set is 69GB in size. The data set spans the years 2009 through 2022 and contains one parquet file per month. Here’s what you should expect to see for a single year:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="st">"~/Datasets/nyc-taxi/year=2018"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "month=1/part-0.parquet"  "month=10/part-0.parquet"
 [3] "month=11/part-0.parquet" "month=12/part-0.parquet"
 [5] "month=2/part-0.parquet"  "month=3/part-0.parquet" 
 [7] "month=4/part-0.parquet"  "month=5/part-0.parquet" 
 [9] "month=6/part-0.parquet"  "month=7/part-0.parquet" 
[11] "month=8/part-0.parquet"  "month=9/part-0.parquet" </code></pre>
</div>
</div>
<p>In any case, if you want to use the full NYC taxi data, the command you use to open the data set is the same: you just point R to the folder containing the full data set rather than the tiny one.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>nyc_taxi <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(<span class="st">"~/Datasets/nyc-taxi/"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Regardless of which version of the data you’re using, you’re good to go.</p>
</section>
<section id="ancillary-data-files" class="level3">
<h3 class="anchored" data-anchor-id="ancillary-data-files">Ancillary data files</h3>
<p>Before moving on, it’s worth mentioning that the <a href="https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page">NYC taxi data website</a> also includes a <a href="data/taxi_zone_lookup.csv">taxi_zone_lookup.csv</a> file that includes human-readable names for the taxi zones. We’ll be using that file in the workshop, so you may wish to download iit also. Here’s a quick look at its contents:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>zones <span class="ot">&lt;-</span> <span class="fu">read_csv_arrow</span>(<span class="st">"data/taxi_zone_lookup.csv"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>zones</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 265 × 4
   LocationID Borough       Zone                    service_zone
        &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;                   &lt;chr&gt;       
 1          1 EWR           Newark Airport          EWR         
 2          2 Queens        Jamaica Bay             Boro Zone   
 3          3 Bronx         Allerton/Pelham Gardens Boro Zone   
 4          4 Manhattan     Alphabet City           Yellow Zone 
 5          5 Staten Island Arden Heights           Boro Zone   
 6          6 Staten Island Arrochar/Fort Wadsworth Boro Zone   
 7          7 Queens        Astoria                 Boro Zone   
 8          8 Queens        Astoria Park            Boro Zone   
 9          9 Queens        Auburndale              Boro Zone   
10         10 Queens        Baisley Park            Boro Zone   
# … with 255 more rows</code></pre>
</div>
</div>
<p>Finally, it’s also worth mentioning that the website has a shapefile specifying the boundaries of the taxi zones and a csv file with some additional information about them. The tutorial doesn’t use this spatial data (except very briefly at the very end) so you ton’t really need it, but it’s helpful to mention here because it’s a hany way to make sense of the geography of the taxi zones. Using the shapefile together with the <strong>sf</strong> and <strong>ggplot2</strong> packages we can draw a map of the taxi zones coloured by their numeric identifier:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>shapefile <span class="ot">&lt;-</span> <span class="st">"data/taxi_zones/taxi_zones.shp"</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>shapedata <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(shapefile)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>shapedata <span class="sc">|&gt;</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> LocationID)) <span class="sc">+</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> .<span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="packages-and-data_files/figure-html/taxi-zones-map-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It’s not really needed, but if you do want a copy of this shapefile, download and unzip the <a href="data/taxi_zones.zip">taxi_zones.zip</a> archive file.</p>
</section>
</section>
<section id="checks" class="level2">
<h2 class="anchored" data-anchor-id="checks">Checks</h2>
<section id="loading-the-data" class="level3">
<h3 class="anchored" data-anchor-id="loading-the-data">Loading the data</h3>
<p>Here’s what you should expect to see when you print the <code>nyc_taxi</code> object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>nyc_taxi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>FileSystemDataset with 158 Parquet files
vendor_name: string
pickup_datetime: timestamp[ms]
dropoff_datetime: timestamp[ms]
passenger_count: int64
trip_distance: double
pickup_longitude: double
pickup_latitude: double
rate_code: string
store_and_fwd: string
dropoff_longitude: double
dropoff_latitude: double
payment_type: string
fare_amount: double
extra: double
mta_tax: double
tip_amount: double
tolls_amount: double
total_amount: double
improvement_surcharge: double
congestion_surcharge: double
pickup_location_id: int64
dropoff_location_id: int64
year: int32
month: int32</code></pre>
</div>
</div>
<p>Okay, so we’re <code>nyc_taxi</code> linked to 158 files. What does that mean in terms of number of rows? How big is the table?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(nyc_taxi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1672590319</code></pre>
</div>
</div>
<p>About 1.7 billion rows. That’s quite a lot.</p>
</section>
<section id="a-dplyr-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="a-dplyr-pipeline">A dplyr pipeline</h3>
<p>If you want to make sure everything is working properly, let’s do a simple analysis. We’ll count the number of trips with destinations in each zone:</p>
<div class="cell" data-hash="packages-and-data_cache/html/use-arrowplyr_b64efdda0f581937f3b006ba157bbf14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>zone_counts <span class="ot">&lt;-</span> nyc_taxi <span class="sc">|&gt;</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(dropoff_location_id) <span class="sc">|&gt;</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>zone_counts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 265 × 2
   dropoff_location_id          n
                 &lt;int&gt;      &lt;int&gt;
 1                  NA 1249152360
 2                 236   16489001
 3                 161   15643391
 4                 237   15526930
 5                 170   13328885
 6                 162   12631075
 7                 230   12565352
 8                  48   11482627
 9                 234   11276120
10                 142   11136863
# … with 255 more rows</code></pre>
</div>
</div>
<p>In order for this to calculation to work, both <strong>arrow</strong> and <strong>dplyr</strong> need to be installed and loaded, so this pipeline should work as a good test to see if your installation is working properly!</p>
</section>
<section id="extras" class="level3">
<h3 class="anchored" data-anchor-id="extras">Extras!</h3>
<p>A few other things just for interests sake. If you’re curious to know how long the analysis is expected to take, this is how long it took to run on my laptop. For the sake of simplicity, throughout the workshop we’ll use the <strong>tictoc</strong> package for timing:</p>
<div class="cell" data-hash="packages-and-data_cache/html/use-tictoc_768d864d07a7f574278eed32661d4a9d">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>() <span class="co"># start timer</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>nyc_taxi <span class="sc">|&gt;</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(dropoff_location_id) <span class="sc">|&gt;</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>() <span class="co"># suppress printing</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>() <span class="co"># stop timer</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>37.541 sec elapsed</code></pre>
</div>
</div>
<p>To give a sense of what this result means geographically, because the zones codes aren’t very meaningful without seeing them on a map, here’s that result shown as a heat map:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> shapedata, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> zone_counts, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"LocationID"</span> <span class="ot">=</span> <span class="st">"dropoff_location_id"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">fill =</span> n)) <span class="sc">+</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> .<span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Number of trips"</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">17000000</span>), </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">label_comma</span>(),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="packages-and-data_files/figure-html/dropoff-heatmap-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Pretty, yes?</p>


</section>
</section>

</main> <!-- /main -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>